<!DOCTYPE html>
<html lang="fr">
<head>
            <title>Cyclopy - Django REST API #3 : Authentification / Permissions</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Author -->
        <meta name="author" content="Marc-Aurele Coste">

        <!-- Foundation CSS -->
        <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/css/foundation.min.css" integrity="sha256-xpOKVlYXzQ3P03j397+jWFZLMBXLES3IiryeClgU5og= sha384-gP4DhqyoT9b1vaikoHi9XQ8If7UNLO73JFOOlQV1RATrA7D0O7TjJZifac6NwPps sha512-AKwIib1E+xDeXe0tCgbc9uSvPwVYl6Awj7xl0FoaPFostZHOuDQ1abnDNCYtxL/HWEnVOMrFyf91TDgLPi9pNg==" crossorigin="anonymous"> -->

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <!-- FontAwesome -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

        <!-- Theme CSS -->
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!-- IE -->
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->






        <meta name="tags" content="Python" />
        <meta name="tags" content="Django" />
        <meta name="tags" content="REST API" />

</head>

<body id="index" class="d-flex flex-column h-100">

    <header>
        <!-- Fixed navbar -->
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <a class="navbar-brand" href="/">Cyclopy</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    


                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">Catégories</a>
                        <div class="dropdown-menu" aria-labelledby="dropdown01">
                                <a class="dropdown-item" href="/category/developpement.html">Développement</a>
                                <a class="dropdown-item" href="/category/linux.html">Linux</a>
                        </div>
                    </li>

                </ul>
            </div>

        </nav>
    </header>

    <main role="main" class="flex-shrink-0">
        <div class="container">

<article class="hentry">
    <header>
        <h2 class="entry-title">
            <a href="/django-rest-api-03.html" rel="bookmark" title="Permalink to Django REST API #3 : Authentification / Permissions">
                Django REST API #3 : Authentification / Permissions
            </a>
        </h2>

        
    </header>

    <footer class="post-info">
        <time class="published" datetime="2019-05-11T22:00:00+02:00">
            Sat 11 May 2019
        </time>


        <div class="category">
            Category: <a href="/category/developpement.html">Développement</a>
        </div>

        <div class="tags">
            Tags:
            <a href="/tag/python.html">Python</a>
            <a href="/tag/django.html">Django</a>
            <a href="/tag/rest-api.html">REST API</a>
        </div>
    </footer><!-- /.post-info -->

    <div class="entry-content">
        <p>Notre API de Todo(s) fonctionne bien. En plus de pouvoir <em>lister</em>, <em>créer</em>, <em>modifier</em>, <em>supprimer</em> des éléments de
notre base de données elle nous permet également de filtrer les résultats selon divers paramètres (e.g. le titre, la
description, ...).</p>
<p>Mais un fondamental est manquant, la gestion des utilisateurs, sauf si bien sûr vous faites une API ouverte avec de la
donnée libre d'accès. Cette gestion permettra surtout de faire l'association entre une donnée et son <em>propriétaire</em>.</p>
<div class="section" id="settings">
<h2>Settings</h2>
<p>On commence par changer nos settings. On ajoute l'application &quot;rest_framework.authtoken&quot; qui permettra
l'authentification via un token (ce sera utile en production) et dans les settings de DRF nous ajoutons une
restriction : <strong>les utilisateurs doivent être authentifiés pour pouvoir utiliser notre API</strong>.</p>
<div class="highlight"><pre><span></span><span class="c1"># common.py</span>
<span class="o">...</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s1">&#39;rest_framework.authtoken&#39;</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">]</span>
<span class="o">...</span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.permissions.IsAuthenticated&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.authentication.TokenAuthentication&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
<p>Dans le fichier de settings pour le développement nous ajoutons ceci pour autoriser l'utilisation de la
'basic authentication'. Cela simplifiera nos tests.</p>
<div class="highlight"><pre><span></span><span class="c1"># development.py</span>
<span class="o">...</span>
<span class="c1"># REST Framework</span>
<span class="n">REST_FRAMEWORK</span><span class="p">[</span><span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;rest_framework.authentication.BasicAuthentication&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework.authentication.TokenAuthentication&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="creation-du-modele-todouser">
<h2>Création du modèle TodoUser</h2>
<p>Nous allons créer un utilisateur pour notre application. Django fournit un modèle User de base mais nous allons wrapper
ce modèle avec notre propre classe et en utilisant une liaison <strong>OneToOne</strong>. On peut voir cet &quot;utilisateur&quot; plus comme
un profile. Cela nous offrira également plus de flexibilité si nous voulons ajouter des informations à notre utilisateur
dans le futur.</p>
<p>On va dans notre fichier <span class="red">models.py</span></p>
<div class="highlight"><pre><span></span><span class="c1"># models.py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">Todo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;TodoUser&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoUser</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">d_user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_user</span><span class="o">.</span><span class="n">username</span>
</pre></div>
</div>
<div class="section" id="creation-d-une-tache-assignation-du-proprietaire">
<h2>Création d'une tâche: assignation du propriétaire</h2>
<p>La création de nos tâches doit maintenant être modifiée. En plus des informations <strong>title</strong>, <strong>description</strong> et
<strong>finished</strong> il nous faut maintenant définir le <strong>owner</strong>. Pour cela on va se baser sur l'utilisateur qui envoie la
requête étant donnée que maintenant pour utiliser notre API il faut être authentifié. Nous allons overwrite la méthode
create du serializer pour creer une tâche avec une liaison vers le user qui a envoyé la requête.</p>
<div class="highlight"><pre><span></span><span class="c1"># serializers.py</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="n">request_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">user</span>
        <span class="n">todo_user</span> <span class="o">=</span> <span class="n">TodoUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d_user</span><span class="o">=</span><span class="n">request_user</span><span class="p">)</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">Todo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">todo_user</span><span class="p">)</span>
        <span class="n">todo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">todo</span>
</pre></div>
</div>
<div class="section" id="filter-les-resultats">
<h2>Filter les résultats</h2>
<p>Tout comme la création, la récupération des résultats doit être modifiée. En effet je ne veux voir que les tâches que
j'ai créé et pas celles des autres. Il faut donc filtrer les résultats qui vont être retournés. C'est dans le viewset
que l'on a défini la queryset et c'est donc dans cette classe que nous allons agir pour filtrer les résultats.</p>
<div class="highlight"><pre><span></span><span class="c1"># views.py</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoViewset</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="n">todo_user</span> <span class="o">=</span> <span class="n">TodoUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d_user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">todo_user</span><span class="p">)</span>
</pre></div>
<p>Voilà maintenant les résultats retournés sont différents en fonction de l'utilisateur qui fait la requête.</p>
<p>Les sources : <a class="reference external" href="https://github.com/MarcAureleCoste/DjangoRestApiTutorial/tree/S03-filters">GitHub</a></p>
</div>

    </div><!-- /.entry-content -->
</article>



        </div>
    </main>

    <footer class="footer mt-auto py-3">
        <div class="container">
            <!-- <span class="text-muted">Place sticky footer content here.</span> -->
            <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of
                <a href="http://python.org">Python</a>.
            </address>
        </div>
    </footer>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <!-- JQuery -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script> -->
    <!-- Foundation JS -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/js/foundation.min.js" integrity="sha256-/PFxCnsMh+nTuM0k3VJCRch1gwnCfKjaP8rJNq5SoBg= sha384-9ksAFjQjZnpqt6VtpjMjlp2S0qrGbcwF/rvrLUg2vciMhwc1UJJeAAOLuJ96w+Nj sha512-UMSn6RHqqJeJcIfV1eS2tPKCjzaHkU/KqgAnQ7Nzn0mLicFxaVhm9vq7zG5+0LALt15j1ljlg8Fp9PT1VGNmDw==" crossorigin="anonymous"></script> -->
    <!-- <script>
        $(document).foundation();
    </script> -->
</body>
</html>